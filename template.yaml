AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Slack GPT bot
Resources:
  SlackGPTBotResponse:
    Type: AWS::Serverless::Function
    Properties:
      Handler: app.lambda_handler
      Runtime: python3.9
      CodeUri: ./src
      Description: Slack bot Event API responder
      MemorySize: 128
      Timeout: 30
      FunctionUrlConfig:
        AuthType: NONE
      Environment:
        Variables:
          LOG_LEVEL: !Ref LogLevel
      Layers:
        - arn:aws:lambda:ap-southeast-2:017000801446:layer:AWSLambdaPowertoolsPythonV2:19
      Role: !Sub "arn:aws:iam::${AWS::AccountId}:role/SlackGPTBotRole"
      Policies:
        - LambdaInvokePolicy:
            FunctionName: SlackGPTBotResponse
      Tracing: !Ref Tracing
      Events:
        PingEvent:
          Type: ScheduleV2
          Properties:
            ScheduleExpression: rate(2 minutes)
            Description: Ping the Slack bot every couple of minutes.
Parameters:
  LogLevel:
    Type: String
    Default: INFO
    Description: Log level
    AllowedValues:
      - DEBUG
      - INFO
      - WARNING
      - ERROR
      - CRITICAL
  Tracing:
    Type: String
    Default: Active
    Description: Tracing mode
    AllowedValues:
      - Active
      - PassThrough
